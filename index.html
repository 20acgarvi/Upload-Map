<!DOCTYPE HTML>
<html>
    <head>
        <style type="text/css" media="screen">
            body{
                margin: 0;
                color: white;
                background: navy;
            }
            canvas{
                background: white; 
            }

            /* Dropdown Button */
            .dropbtn {
            background-color: #3498DB;
            color: white;
            padding-top: 16px;
            padding-bottom: 16px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            }

            /* Dropdown button on hover & focus */
            .dropbtn:hover, .dropbtn:focus {
            background-color: #2980B9;
            }

            /* The container <div> - needed to position the dropdown content */
            .dropdown {
            position: relative;
            display: inline-block;
            }

            /* Dropdown Content (Hidden by Default) */
            .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            }

            /* Links inside the dropdown */
            .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            }

            /* Change color of dropdown links on hover */
            .dropdown-content a:hover {background-color: #ddd}

            /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
            .show {display:block;}
        </style> 
    </head>

    <body>
        <!-- dropdown -->
        <div class="dropdown" style="top:110px; left:498px">
            <button onclick="show_dropdown(this)" class="dropbtn" style="padding-left:120px; padding-right:120px;">
                Start Location
            </button>
            <div id="startDropdown" class="dropdown-content">
            </div>
        </div>

        <div class="dropdown" style="top:110px; left:500px">
            <button onclick="show_dropdown(this)" class="dropbtn" style="padding-left:133px; padding-right:133px;">
                Destination
            </button>
            <div id="destDropdown" class="dropdown-content">
            </div>
        </div>

        <!-- creates upload image and reserves space for image -->
        <input type='file' style="position:absolute; top:580px; left:950px;"/> 
        <img id="myImg" src="#" alt="your image" height=0 width=0>
        <!-- canvas width and height properties are reset in script -->
        <div style="position:absolute; top:170px; left:500px;" >
            <canvas id="canvas" width="0" height="0"></canvas>
        </div>

        <script>
            function contains(arr, target){
                for(var i = 0; i < arr.length; i++){
                    if(JSON.stringify(target) == JSON.stringify(arr[i])){
                        return true;
                    }
                }
                return false;
            }

            function Node(x,y){
                this.x = x;
                this.y = y;
            }

            Node.prototype.distance = function(n) {
                return Math.hypot(n.x - this.x, n.y - this.y);
            }

            var canvas = document.getElementById("canvas");
            var canvas_active = true;
            canvas.width = 700;
            canvas.height = 400;
            var rect = canvas.getBoundingClientRect();
            var ctx = canvas.getContext("2d");

            var graph = [];
            var nodes = [];
            var strt, dest, info;

            function addConnection(a,b){
                if (nodes[a] == undefined || nodes[b] == undefined) {
                    return;
                }
                if (graph[a] == undefined) {
                    graph[a] = {};
                }
                graph[a][b] = nodes[a].distance(nodes[b]);
                if (graph[b] == undefined) {
                    graph[b] = {};
                }
                graph[b][a] = nodes[a].distance(nodes[b]);
            }

            function shortest_path(graph, strt){
                //create costs array
                costs = {};
                indices = Object.keys(graph[strt]);
                for(var i = 0; i < indices.length; i++) {
                    costs[indices[i]] = graph[strt][indices[i]];
                }
                for(let n in Object.keys(graph)) {
                    if ((costs[n] == undefined) && (n != strt)) {
                        costs[n] = Infinity;
                    }
                }

                //create parents array
                parents = {};
                indices = Object.keys(graph[strt]);
                for(var i = 0; i < indices.length; i++) {
                    parents[indices[i]] = strt;
                } 

                processed = [];

                //finds the lowest cost path
                node = find_lowest_cost_node(costs, processed);
                while (node != null){
                    cost = costs[node];
                    neighbors = graph[node];
                    for (let n in neighbors){
                        new_cost = cost + neighbors[n];
                        if (costs[n] > new_cost){
                            costs[n] = new_cost;
                            parents[n] = node;
                        }
                    } 
                    processed.push(node);
                    node = find_lowest_cost_node(costs, processed);
                }
                return{"parents" : parents, "costs" : costs};
            }

            function find_lowest_cost_node(costs, processed) {
                lowest_cost = Infinity;
                lowest_cost_node = null;
                for (node in costs){
                    cost = costs[node];
                    if ((cost < lowest_cost) & !(processed.includes(node))){
                        lowest_cost = cost;
                        lowest_cost_node = node;
                    }
                }
                return lowest_cost_node;
            }

            let moved;
            var initial_x = undefined;
            var initial_y = undefined;
            function mouse_down() {
                if((canvas_active)
                 && (event.clientY > rect.top) && (event.clientX > rect.left)){
                    initial_x = event.clientX - rect.left;
                    initial_y = event.clientY - rect.top;
                    moved = false;
                }
            }
            function mouse_moved(event) { 
                if(canvas_active){
                    moved = true;
                }
            }
            function mouse_evaluate(event) {
                if(canvas_active){
                    current_x = event.clientX - rect.left;
                    current_y = event.clientY - rect.top;
                    if (Math.hypot(initial_x - current_x, initial_y - current_y) < 5) {
                        moved = false;
                    }
                    if (!moved) {
                        //console.log("X: " + current_x + " Y: " + current_y);
                        nodes.push(new Node(current_x, current_y));

                        strtcontent = document.getElementById("startDropdown");
                        var strtnode = document.createElement("a");
                        strtnode.text = nodes.length - 1;
                        strtnode.setAttribute("onClick", "change_text(this.parentNode.parentNode.childNodes[1],this.text); handle_start(this.text)");
                        strtcontent.appendChild(strtnode);

                        destcontent = document.getElementById("destDropdown");
                        var destnode = document.createElement("a");
                        destnode.text = nodes.length - 1;
                        destnode.setAttribute("onClick", "change_text(this.parentNode.parentNode.childNodes[1],this.text); handle_dest(this.text)"); 
                        destcontent.appendChild(destnode);

                        if((info != undefined) && (strt != null) && (dest != null)){
                            draw_nodes(nodes, find_parents(info,strt,dest,[]));
                        } else {
                            draw_nodes(nodes, null);
                        }
                    } else {
                        i = find_nearest_node(initial_x, initial_y, nodes);
                        j = find_nearest_node(current_x, current_y, nodes);
                        if ((i != -1) && (j != -1)) {
                            ctx.beginPath()
                            ctx.moveTo(nodes[i].x, nodes[i].y);
                            ctx.lineTo(nodes[j].x, nodes[j].y);
                            ctx.strokestyle = "FF0000";
                            ctx.stroke();
                            ctx.closePath();
                            addConnection(i,j);
                        }
                    }
                }
            }

            document.addEventListener("mousedown", mouse_down);
            document.addEventListener("mousemove", mouse_moved);
            document.addEventListener("mouseup", mouse_evaluate);

            /*          
            //create sample web
            nodes[0] = new Node(0,0);
            nodes[1] = new Node(1,1);
            nodes[2] = new Node(4,3);
            nodes[3] = new Node(2,-1);
            nodes[4] = new Node(2,-3);
            nodes[5] = new Node(-1,-3);
            nodes[6] = new Node(-3,-1);
            nodes[7] = new Node(-4,2);
            nodes[8] = new Node(-1,3);

            //connections to node 0
            addConnection(0,1);
            addConnection(0,6);
            addConnection(0,7);

            //connections to node 1
            addConnection(1,2);
            addConnection(1,3);

            //connections to node 2
            addConnection(2,8);

            //connections to node 3
            addConnection(3,4);
            addConnection(3,6);

            //connections to node 4
            addConnection(4,5);

            //connections to node 5
            addConnection(5,6);

            //connections to node 6
            addConnection(6,7);

            //connections to node 7
            addConnection(7,8);
            */
            
            

            var map = null;

            window.addEventListener('load', function() {
                document.querySelector('input[type="file"]').addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        map = document.querySelector('img');  // $('img')[0]
                        map.src = URL.createObjectURL(this.files[0]); // set src to blob url
                        map.onload = load_map;
                    }
                });
                });

                function load_map() { 
                    if (map != null){
                        a = map.naturalWidth;
                        b = map.naturalHeight;
                        ctx.drawImage(map,0,0,a,b)
                    }
                    // update width and height ...
                }

                /* When the user clicks on the button, 
                toggle between hiding and showing the dropdown content */
                function show_dropdown(target) {
                    target.parentNode.querySelector('.dropdown-content').classList.toggle("show");
                    canvas_active = !(canvas_active)
                }

                // Close the dropdown menu if the user clicks outside of it
                window.onclick = function(event) {
                if (!event.target.matches('.dropbtn')) {
                    var dropdowns = document.getElementsByClassName("dropdown-content");
                    var i;
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                        canvas_active = true;
                    }
                    }
                }
                }

                function change_text(elem, text){
                    elem.innerText = text;
                }

                function handle_start(index){
                    strt = index;
                    try {
                        info = shortest_path(graph,strt);
                    } catch (error) {
                        console.log("That node doesn\'t exist!")
                    }
                }

                function handle_dest(index){
                    dest = index;
                    if (info != undefined)
                        try {
                            console.log(path = find_parents(info,strt,dest,[]));
                            draw_nodes(nodes, path);
                        } catch(error) {
                            console.log("That node isn\'t connected!");
                        }
                }


            function find_nearest_node(x, y, nodes){
                closest_distance = 10;
                closest_index = -1;
                for(var i = 0; i < Object.keys(nodes).length ; i++){
                    n = nodes[i];
                    distance = Math.hypot(n.x - x, n.y - y);
                    //console.log(distance);
                    if(distance < closest_distance) {
                        closest_distance = distance;
                        closest_index = i;
                    }
                }
                return closest_index;
            }

            function draw_nodes(nodes, path){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                load_map();

                for(var i = 0; i < Object.keys(nodes).length; i++){
                    n = nodes[i];
                    ctx.strokestyle = "FF0000";
                    ctx.beginPath()
                    ctx.arc(n.x, n.y, 5, 0, 2 * Math.PI, false);
                    ctx.linewidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                }
                if(path != null){
                    for(var i = 0; i < Object.keys(graph).length; i++){
                        for(var j = 0; j < Object.keys(graph[i]).length; j++) {
                            a = Object.keys(graph)[i];
                            b = Object.keys(graph[i])[j];
                            arr = [Number(a),Number(b)];
                            if(contains(path, arr)) {
                                ctx.strokestyle = "FF0000";
                                ctx.beginPath()
                                ctx.moveTo(nodes[a].x, nodes[a].y);
                                ctx.lineTo(nodes[b].x, nodes[b].y);
                                ctx.stroke();
                                ctx.closePath();
                            }
                        }
                    }
                } else {
                    for(var i = 0; i < Object.keys(graph).length; i++){
                        for(var j = 0; j < Object.keys(graph[i]).length; j++) {
                            a = Object.keys(graph)[i];
                            b = Object.keys(graph[i])[j];
                            ctx.strokestyle = "FF0000";
                            ctx.beginPath()
                            ctx.moveTo(nodes[a].x, nodes[a].y);
                            ctx.lineTo(nodes[b].x, nodes[b].y);
                            ctx.stroke();
                            ctx.closePath();
                        }
                    }
                }
            }

            //info is shortest_path(graph,strt)
            //destarr is destination array
            function find_parents(info,strt,dest,path) {
                path.push(dest);
                if(strt != dest) {
                    newdest = info.parents[dest];
                    find_parents(info,strt,newdest,path);
                }
                formatted_path = [];
                for(var i = 0; i + 1 < path.length; i++) {
                    arr = [Number(path[i]), Number(path[i+1])];
                    formatted_path[i] = arr;
                }
                return formatted_path;
            }

            /*
            info = shortest_path(graph,0);
            console.log(info.parents);
            console.log(find_parents(info,0,8));
            */
            
            

        </script>
    </body>
</html>
